global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend http_front
    bind *:80
    bind *:443 ssl crt /usr/local/etc/haproxy/certs/oneground.local.pem alpn h2,http/1.1

    # ACLs for routing
    acl is_zaken hdr(host) -i zaken.oneground.local
    acl is_catalogi hdr(host) -i catalogi.oneground.local
    acl is_besluiten hdr(host) -i besluiten.oneground.local
    acl is_documenten hdr(host) -i documenten.oneground.local
    acl is_autorisaties hdr(host) -i autorisaties.oneground.local
    acl is_notificaties hdr(host) -i notificaties.oneground.local
    acl is_referentielijsten hdr(host) -i referentielijsten.oneground.local
    acl is_keycloak hdr(host) -i keycloak.oneground.local

    # Route to backends
    use_backend zaken_back if is_zaken
    use_backend catalogi_back if is_catalogi
    use_backend besluiten_back if is_besluiten
    use_backend documenten_back if is_documenten
    use_backend autorisaties_back if is_autorisaties
    use_backend notificaties_back if is_notificaties
    use_backend referentielijsten_back if is_referentielijsten
    use_backend keycloak_back if is_keycloak

backend zaken_back
    balance roundrobin
    option httpchk GET /health
    server zaken host.docker.internal:5009 check

backend catalogi_back
    balance roundrobin
    option httpchk GET /health
    server catalogi host.docker.internal:5011 check

backend besluiten_back
    balance roundrobin
    option httpchk GET /health
    server besluiten host.docker.internal:5013 check

backend documenten_back
    balance roundrobin
    option httpchk GET /health
    server documenten host.docker.internal:5007 check

backend autorisaties_back
    balance roundrobin
    option httpchk GET /health
    server autorisaties host.docker.internal:5001 check

backend notificaties_back
    balance roundrobin
    option httpchk GET /health
    server notificaties host.docker.internal:5015 check

backend referentielijsten_back
    balance roundrobin
    option httpchk GET /health
    server referentielijsten host.docker.internal:5017 check

backend keycloak_back
    balance roundrobin
    server keycloak host.docker.internal:8080 check
